!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).ShelfPack=t()}(this,(function(){"use strict";class e{constructor(e,t,s,i,h,n=i,r=h,l=0){this.id=e,this.x=t,this.y=s,this.w=i,this.h=h,this.maxw=n,this.maxh=r,this.refcount=l}}class t{constructor(e,t,s,i=0){this.y=e,this.w=t,this.h=s,this.x=i,this.free=t}alloc(t,s,i){if(t>this.free||s>this.h)return null;const h=this.x;return this.x+=t,this.free-=t,new e(i,h,this.y,t,s,t,this.h)}resize(e){this.free+=e-this.w,this.w=e}}return class{constructor(e=64,t=64,s){const i=null!=s?s:{};this.autoResize=!!i.autoResize,this.shelves=[],this.freebins=[],this.stats={},this.bins={},this.maxId=0,this.w=e,this.h=t}pack(e,t={}){const s=[...e],i=[];for(let h=0;h<s.length;h++){const n=s[h].w||s[h].w,r=s[h].h||s[h].h,l=s[h].id;if("number"==typeof n&&"number"==typeof r){const f=this.packOne(n,r,l);if(!f)continue;if(t.inPlace){if("x"in s[h]&&"y"in s[h]){const t=e[h];t.x=f.x,t.y=f.y,t.id=f.id}i.push(f)}}}return this.shrink(),i}packOne(e,s,i){const h={freebin:-1,shelf:-1,waste:1/0};let n,r,l,f,o,a=0;if("string"==typeof i||"number"==typeof i){if(n=this.getBin(i),n)return this.ref(n),n;o=i}else o=++this.maxId;for(f=0;f<this.freebins.length;f++){if(n=this.freebins[f],s===n.maxh&&e===n.maxw)return this.allocFreebin(f,e,s,o);s>n.maxh||e>n.maxw||s<=n.maxh&&e<=n.maxw&&(l=n.maxw*n.maxh-e*s,l<h.waste&&(h.waste=l,h.freebin=f))}for(f=0;f<this.shelves.length;f++)if(r=this.shelves[f],a+=r.h,!(e>r.free)){if(s===r.h)return this.allocShelf(f,e,s,o);s>r.h||s<r.h&&(l=(r.h-s)*e,l<h.waste&&(h.freebin=-1,h.waste=l,h.shelf=f))}if(-1!==h.freebin)return this.allocFreebin(h.freebin,e,s,o);if(-1!==h.shelf)return this.allocShelf(h.shelf,e,s,o);if(s<=this.h-a&&e<=this.w)return r=new t(a,this.w,s),this.allocShelf(this.shelves.push(r)-1,e,s,o);if(this.autoResize){let t,i,h,n;return t=i=this.h,h=n=this.w,(h<=t||e>h)&&(n=2*Math.max(e,h)),(t<h||s>t)&&(i=2*Math.max(s,t)),this.resize(n,i),this.packOne(e,s,o)}return null}allocFreebin(t,s,i,h){const n=this.freebins.splice(t,1)[0],r=new e(h,n.x,n.y,s,i,n.maxw,n.maxh,0);return this.bins[h]=r,this.ref(r),r}allocShelf(e,t,s,i){const h=this.shelves[e].alloc(t,s,i);if(null===h)throw new Error("Failed to allocate bin on shelf.");return this.bins[i]=h,this.ref(h),h}shrink(){if(this.shelves.length>0){let e=0,t=0;for(let s=0;s<this.shelves.length;s++){const i=this.shelves[s];t+=i.h,e=Math.max(i.w-i.free,e)}this.resize(e,t)}}getBin(e){return this.bins[e]}ref(e){return 1==++e.refcount&&(this.stats[e.h]=1+(0|this.stats[e.h])),e.refcount}unref(e){return 0===e.refcount?0:(0==--e.refcount&&(this.stats[e.h]--,delete this.bins[e.id],this.freebins.push(e)),e.refcount)}clear(){this.shelves=[],this.freebins=[],this.stats={},this.bins={},this.maxId=0}resize(e,t){this.w=e,this.h=t;for(let t=0;t<this.shelves.length;t++)this.shelves[t].resize(e);return!0}}}));
//# sourceMappingURL=shelf-pack.min.js.map
